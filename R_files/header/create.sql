CREATE TABLE IF NOT EXISTS header (
  hdr_id INT PRIMARY KEY,
  komitmen_id INT,
  tipe_kegiatan_id INT,
  create_by VARCHAR(16),
  create_date DATE NOT NULL DEFAULT NOW(),
  jenis_kegiatan_id INT,
  hdr_psc_id INT,
  area_id INT,
  basin_id INT,
  cek VARCHAR(32),

  CONSTRAINT fk_komitmen_id FOREIGN KEY (komitmen_id) REFERENCES jenis_komitmen (id),
  CONSTRAINT fk_tipe_kegiatan_id FOREIGN KEY (tipe_kegiatan_id) REFERENCES tipe_kegiatan (id),
  CONSTRAINT fk_hdr_psc_id FOREIGN KEY (hdr_psc_id) REFERENCES psc (id),
  CONSTRAINT fk_area_id FOREIGN KEY (area_id) REFERENCES area (id),
  CONSTRAINT fk_basin_id FOREIGN KEY (basin_id) REFERENCES basin (id)
);

CREATE OR REPLACE FUNCTION insert_cek()
RETURNS TRIGGER AS $$
DECLARE
  tipe_kegiatan_id_varchar VARCHAR(8);
  komitmen_id_varchar VARCHAR(8);
  jenis_kegiatan_id_varchar VARCHAR(8);
  hdr_psc_id_varchar VARCHAR(8);
  res VARCHAR(32);
  cek_exists BOOL := false;
BEGIN
  -- handle tipe_kegiatan_id column
  IF NEW.tipe_kegiatan_id IS NULL THEN
    tipe_kegiatan_id_varchar := '';
  ELSE
    tipe_kegiatan_id_varchar := NEW.tipe_kegiatan_id::VARCHAR;
  END IF;
  
  -- handle komitmen_id
  IF NEW.komitmen_id IS NULL THEN
    komitmen_id_varchar := '';
  ELSE
    komitmen_id_varchar := NEW.komitmen_id::VARCHAR;
  END IF;

  -- handle jenis_kegiatan
  IF NEW.jenis_kegiatan_id IS NULL THEN
    jenis_kegiatan_id_varchar := '';
  ELSE
    jenis_kegiatan_id_varchar := NEW.jenis_kegiatan_id::VARCHAR;
  END IF;

  -- handle hdr_psc_id
  IF NEW.hdr_psc_id IS NULL THEN
    hdr_psc_id_varchar := '';
  ELSE
    hdr_psc_id_varchar := NEW.hdr_psc_id::VARCHAR;
  END IF;
  
  -- cek full value
  res := tipe_kegiatan_id_varchar || komitmen_id_varchar || jenis_kegiatan_id_varchar || hdr_psc_id_varchar;
  NEW.cek := (res);

  -- check if cek exists
  IF NEW.hdr_id IS NULL THEN
    NEW.hdr_id := (SELECT COALESCE(MAX(hdr_id), 0) + 1 FROM header);
  END IF;

  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER insert_hdr_id
BEFORE INSERT
ON header
FOR EACH ROW
EXECUTE PROCEDURE insert_cek();


-- NOTE: header table inserts
INSERT INTO
  header (hdr_id, komitmen_id, tipe_kegiatan_id, create_by, create_date, jenis_kegiatan_id, hdr_psc_id, area_id, basin_id)
VALUES
(1150,0,366,'MANUAL','2025-03-11',48,65,4,5),
(1151,1,366,'MANUAL','2025-03-11',196,9,4,5),
(1152,1,366,'MANUAL','2025-03-11',60,9,1,NULL),
(1153,3,366,'MANUAL','2025-03-11',253,55,1,NULL),
(1154,3,366,'MANUAL','2025-03-11',245,55,9,12),
(1155,3,366,'MANUAL','2025-03-11',227,55,9,12),
(1156,2,366,'MANUAL','2025-03-11',46,180,9,12),
(1157,2,366,'MANUAL','2025-03-11',119,180,9,12),
(1158,2,366,'MANUAL','2025-03-11',123,7,8,NULL),
(1159,2,366,'MANUAL','2025-03-11',46,7,8,NULL),
(1160,2,366,'MANUAL','2025-03-11',105,7,8,NULL),
(1161,2,366,'MANUAL','2025-03-11',31,57,3,4),
(1162,2,366,'MANUAL','2025-03-11',92,57,3,4),
(1163,2,366,'MANUAL','2025-03-11',59,57,3,4),
(1164,2,366,'MANUAL','2025-03-11',251,57,3,4),
(1165,2,366,'MANUAL','2025-03-11',46,57,3,4),
(1166,2,366,'MANUAL','2025-03-11',60,27,3,4),
(1167,2,366,'MANUAL','2025-03-11',216,27,3,4),
(1168,2,366,'MANUAL','2025-03-11',103,27,12,11),
(1169,2,366,'MANUAL','2025-03-11',210,27,12,11),
(1170,2,366,'MANUAL','2025-03-11',101,27,12,11),
(1171,3,366,'MANUAL','2025-03-11',223,39,12,11),
(1172,3,366,'MANUAL','2025-03-11',154,39,12,11),
(1173,3,366,'MANUAL','2025-03-11',228,31,12,11),
(1174,3,366,'MANUAL','2025-03-11',128,31,12,11),
(1175,2,366,'MANUAL','2025-03-11',60,20,12,11),
(1176,2,366,'MANUAL','2025-03-11',46,20,12,11),
(1177,2,366,'MANUAL','2025-03-11',201,20,12,11),
(1178,2,366,'MANUAL','2025-03-11',84,42,12,11),
(1179,2,366,'MANUAL','2025-03-11',59,42,12,11),
(1180,2,366,'MANUAL','2025-03-11',139,42,12,11),
(1181,2,366,'MANUAL','2025-03-11',109,42,12,11),
(1182,2,366,'MANUAL','2025-03-11',54,42,12,11),
(1183,2,366,'MANUAL','2025-03-11',116,42,12,11),
(1184,2,366,'MANUAL','2025-03-11',55,42,12,11),
(1185,2,366,'MANUAL','2025-03-11',115,42,12,11),
(1186,2,366,'MANUAL','2025-03-11',114,42,9,12),
(1187,2,366,'MANUAL','2025-03-11',100,42,9,12),
(1188,2,366,'MANUAL','2025-03-11',94,42,9,12),
(1189,2,366,'MANUAL','2025-03-11',138,42,9,12),
(1190,3,366,'MANUAL','2025-03-11',237,40,9,12),
(1191,3,366,'MANUAL','2025-03-11',154,40,9,12),
(1192,2,366,'MANUAL','2025-03-11',248,26,9,12),
(1193,2,366,'MANUAL','2025-03-11',46,26,9,12),
(1194,2,366,'MANUAL','2025-03-11',120,26,9,12),
(1195,0,366,'MANUAL','2025-03-11',130,13,9,12),
(1196,0,366,'MANUAL','2025-03-11',48,13,9,12),
(1197,3,366,'MANUAL','2025-03-11',110,61,9,12),
(1198,3,366,'MANUAL','2025-03-11',228,61,9,12),
(1199,0,366,'MANUAL','2025-03-11',59,58,4,5),
(1200,0,366,'MANUAL','2025-03-11',131,58,4,5),
(1201,0,366,'MANUAL','2025-03-11',48,58,11,13),
(1202,3,366,'MANUAL','2025-03-11',234,8,11,13),
(1203,3,366,'MANUAL','2025-03-11',185,8,12,11),
(1204,3,366,'MANUAL','2025-03-11',184,8,12,11),
(1205,3,366,'MANUAL','2025-03-11',186,8,12,11),
(1206,3,366,'MANUAL','2025-03-11',233,8,12,11),
(1207,3,366,'MANUAL','2025-03-11',154,8,12,11),
(1208,2,366,'MANUAL','2025-03-11',105,32,12,11),
(1209,2,366,'MANUAL','2025-03-11',46,32,12,11),
(1210,2,366,'MANUAL','2025-03-11',228,32,12,11),
(1211,2,366,'MANUAL','2025-03-11',123,32,12,11),
(1212,3,366,'MANUAL','2025-03-11',240,19,12,11),
(1213,3,366,'MANUAL','2025-03-11',209,19,12,11),
(1214,3,366,'MANUAL','2025-03-11',154,19,12,11),
(1215,3,366,'MANUAL','2025-03-11',228,21,12,11),
(1216,3,366,'MANUAL','2025-03-11',21,21,0,11),
(1217,3,366,'MANUAL','2025-03-11',101,21,0,11),
(1218,3,366,'MANUAL','2025-03-11',240,41,0,11),
(1219,3,366,'MANUAL','2025-03-11',169,41,0,6),
(1220,3,366,'MANUAL','2025-03-11',28,41,0,6),
(1221,3,366,'MANUAL','2025-03-11',46,41,0,6),
(1222,2,366,'MANUAL','2025-03-11',59,24,0,11),
(1223,2,366,'MANUAL','2025-03-11',22,24,0,6),
(1224,2,366,'MANUAL','2025-03-11',154,24,0,6),
(1225,2,366,'MANUAL','2025-03-11',154,33,0,6),
(1226,2,366,'MANUAL','2025-03-11',48,2,0,6),
(1227,2,366,'MANUAL','2025-03-11',60,2,0,6),
(1228,2,366,'MANUAL','2025-03-11',209,2,0,11),
(1229,2,366,'MANUAL','2025-03-11',228,62,0,11),
(1230,2,366,'MANUAL','2025-03-11',217,62,0,6),
(1231,2,366,'MANUAL','2025-03-11',103,62,0,6),
(1232,2,366,'MANUAL','2025-03-11',133,62,0,6),
(1233,2,366,'MANUAL','2025-03-11',117,62,0,6),
(1234,2,366,'MANUAL','2025-03-11',248,50,0,6),
(1235,2,366,'MANUAL','2025-03-11',46,50,0,11),
(1236,2,366,'MANUAL','2025-03-11',228,50,0,11),
(1237,2,366,'MANUAL','2025-03-11',123,50,0,6),
(1238,3,366,'MANUAL','2025-03-11',59,11,0,6),
(1239,3,366,'MANUAL','2025-03-11',137,11,0,11),
(1240,3,366,'MANUAL','2025-03-11',154,11,0,11),
(1241,2,366,'MANUAL','2025-03-11',228,28,0,6),
(1242,2,366,'MANUAL','2025-03-11',140,28,9,12),
(1243,2,366,'MANUAL','2025-03-11',154,28,9,12),
(1244,0,366,'MANUAL','2025-03-11',73,47,5,8),
(1245,2,366,'MANUAL','2025-03-11',60,5,5,8),
(1246,2,366,'MANUAL','2025-03-11',103,5,5,8),
(1247,2,366,'MANUAL','2025-03-11',215,5,5,8),
(1248,2,366,'MANUAL','2025-03-11',212,5,5,8),
(1249,2,366,'MANUAL','2025-03-11',213,5,5,8),
(1250,2,366,'MANUAL','2025-03-11',134,5,5,8),
(1251,2,366,'MANUAL','2025-03-11',209,5,5,8),
(1252,1,366,'MANUAL','2025-03-11',60,16,5,8),
(1253,1,366,'MANUAL','2025-03-11',99,16,5,8),
(1254,1,366,'MANUAL','2025-03-11',197,16,5,8),
(1255,1,366,'MANUAL','2025-03-11',243,59,12,11),
(1256,1,366,'MANUAL','2025-03-11',196,59,12,11),
(1257,2,366,'MANUAL','2025-03-11',89,34,12,11),
(1258,2,366,'MANUAL','2025-03-11',87,34,12,11),
(1259,2,366,'MANUAL','2025-03-11',129,34,12,11),
(1260,2,366,'MANUAL','2025-03-11',73,34,1,4),
(1261,2,366,'MANUAL','2025-03-11',46,34,1,4),
(1262,3,366,'MANUAL','2025-03-11',242,52,1,4),
(1263,3,366,'MANUAL','2025-03-11',154,52,1,4),
(1264,2,366,'MANUAL','2025-03-11',248,0,4,5),
(1265,2,366,'MANUAL','2025-03-11',105,0,4,5),
(1266,2,366,'MANUAL','2025-03-11',123,0,4,5),
(1267,2,366,'MANUAL','2025-03-11',46,0,4,5),
(1268,3,366,'MANUAL','2025-03-11',48,64,4,5),
(1269,0,366,'MANUAL','2025-03-11',189,64,4,5),
(1270,3,366,'MANUAL','2025-03-11',218,49,4,5),
(1271,2,366,'MANUAL','2025-03-11',60,22,9,12),
(1272,2,366,'MANUAL','2025-03-11',215,22,9,12),
(1273,2,366,'MANUAL','2025-03-11',101,22,9,12),
(1274,2,366,'MANUAL','2025-03-11',59,22,9,12),
(1275,0,366,'MANUAL','2025-03-11',106,37,9,12),
(1276,3,366,'MANUAL','2025-03-11',240,23,9,12),
(1277,3,366,'MANUAL','2025-03-11',214,23,9,12),
(1278,3,366,'MANUAL','2025-03-11',154,23,9,12),
(1279,2,366,'MANUAL','2025-03-11',60,6,9,12),
(1280,2,366,'MANUAL','2025-03-11',211,6,11,13),
(1281,2,366,'MANUAL','2025-03-11',101,6,11,13),
(1282,0,366,'MANUAL','2025-03-11',232,35,11,13),
(1283,0,366,'MANUAL','2025-03-11',130,35,2,1),
(1284,0,366,'MANUAL','2025-03-11',48,35,2,1),
(1285,0,366,'MANUAL','2025-03-11',130,36,2,1),
(1286,0,366,'MANUAL','2025-03-11',109,36,12,11),
(1287,0,366,'MANUAL','2025-03-11',48,36,12,11),
(1288,1,366,'MANUAL','2025-03-11',191,51,12,11),
(1289,1,366,'MANUAL','2025-03-11',196,51,12,11),
(1290,1,366,'MANUAL','2025-03-11',60,51,12,11),
(1291,1,366,'MANUAL','2025-03-11',48,51,3,3),
(1292,1,366,'MANUAL','2025-03-11',33,51,3,3),
(1293,0,366,'MANUAL','2025-03-11',126,30,3,3),
(1294,0,366,'MANUAL','2025-03-11',182,30,3,3),
(1295,2,366,'MANUAL','2025-03-11',150,43,3,3);
