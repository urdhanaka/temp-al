CREATE TABLE IF NOT EXISTS format_data_baru (
  table_id int GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
  hdr_id INT UNIQUE,
  wk_id VARCHAR(64),
  area_id INT,
  basin_id INT,
  komitmen_id INT,
  jenis_kegiatan_id INT,
  holding_id INT,
  jenis_wk_id INT,
  tipe_kegiatan_id INT,
  jenis_unit_id INT,
  hdr_psc_id INT,

  CONSTRAINT fk_wk_id FOREIGN KEY (wk_id) REFERENCES mdm (wk_id),
  CONSTRAINT fk_area_id FOREIGN KEY (area_id) REFERENCES area (id),
  CONSTRAINT fk_basin_id FOREIGN KEY (basin_id) REFERENCES basin (id),
  CONSTRAINT fk_komitmen_id FOREIGN KEY (komitmen_id) REFERENCES jenis_komitmen (id),
  CONSTRAINT fk_jenis_kegiatan_id FOREIGN KEY (jenis_kegiatan_id) REFERENCES jenis_kegiatan (id),
  CONSTRAINT fk_holding_id FOREIGN KEY (holding_id) REFERENCES holding (id),
  CONSTRAINT fk_jenis_wk_id FOREIGN KEY (jenis_wk_id) REFERENCES jenis_wk (id),
  CONSTRAINT fk_tipe_kegiatan_id FOREIGN KEY (tipe_kegiatan_id) REFERENCES tipe_kegiatan (id),
  CONSTRAINT fk_jenis_unit_id FOREIGN KEY (jenis_unit_id) REFERENCES jenis_unit (id),
  CONSTRAINT fk_hdr_psc_id FOREIGN KEY (hdr_psc_id) REFERENCES psc (id)
);

CREATE OR REPLACE FUNCTION insert_to_header()
RETURNS TRIGGER AS $$
DECLARE
  exists_hdr_id INT;
BEGIN
  exists_hdr_id := (
    SELECT hdr_id FROM header WHERE
    komitmen_id = NEW.komitmen_id AND
    tipe_kegiatan_id = NEW.tipe_kegiatan_id AND
    jenis_kegiatan_id = NEW.jenis_kegiatan_id AND
    hdr_psc_id = NEW.hdr_psc_id
  );

  IF exists_hdr_id IS NOT NULL THEN
    NEW.hdr_id := exists_hdr_id;
  ELSE
    INSERT INTO
      header (komitmen_id, tipe_kegiatan_id, create_by, jenis_kegiatan_id, hdr_psc_id, area_id, basin_id)
    VALUES
      (NEW.komitmen_id, NEW.tipe_kegiatan_id, 'MANUAL', NEW.jenis_kegiatan_id, NEW.hdr_psc_id, NEW.area_id, NEW.basin_id);
    
    NEW.hdr_id := (
      SELECT hdr_id FROM header WHERE
      komitmen_id = NEW.komitmen_id AND
      tipe_kegiatan_id = NEW.tipe_kegiatan_id AND
      jenis_kegiatan_id = NEW.jenis_kegiatan_id AND
      hdr_psc_id = NEW.hdr_psc_id
    );
  END IF;

  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER insert_hdr_id_format_data_baru
BEFORE INSERT
ON format_data_baru
FOR EACH ROW
EXECUTE PROCEDURE insert_to_header();

INSERT INTO
  format_data_baru (wk_id, area_id, basin_id, komitmen_id, jenis_kegiatan_id, holding_id, jenis_wk_id, tipe_kegiatan_id, jenis_unit_id, hdr_psc_id)
VALUES
('WK00000024',4,5,0,48,12,367,366,29,65),
('WK00000516',1,NULL,1,196,2,367,366,30,9),
('WK00000516',1,NULL,1,60,2,367,366,31,9),
('WK00000041',9,12,3,245,5,367,366,40,55),
('WK00000041',9,12,3,253,5,367,366,29,55),
('WK00000041',9,12,3,227,5,367,366,31,55),
('WK00000042',8,NULL,2,119,1,367,366,30,180),
('WK00000042',8,NULL,2,46,1,367,366,29,180),
('WK00000057',3,4,2,105,14,367,366,32,7),
('WK00000057',3,4,2,123,14,367,366,30,7),
('WK00000057',3,4,2,46,14,367,366,29,7),
('WK00000082',12,11,2,31,12,367,366,29,57),
('WK00000082',12,11,2,251,12,367,366,29,57),
('WK00000082',12,11,2,92,12,367,366,33,57),
('WK00000082',12,11,2,59,12,367,366,31,57),
('WK00000082',12,11,2,46,12,367,366,29,57),
('WK00000081',9,12,2,216,3,367,366,30,27),
('WK00000081',9,12,2,210,3,367,366,32,27),
('WK00000081',9,12,2,60,3,367,366,31,27),
('WK00000081',9,12,2,103,3,367,366,29,27),
('WK00000081',9,12,2,101,3,367,366,29,27),
('WK00000096',4,5,3,223,17,367,366,31,39),
('WK00000096',4,5,3,154,17,367,366,29,39),
('WK00000113',11,13,3,228,5,367,366,31,31),
('WK00000113',11,13,3,128,5,367,366,30,31),
('WK00000175',12,11,2,201,18,367,366,33,20),
('WK00000175',12,11,2,60,18,367,366,31,20),
('WK00000175',12,11,2,46,18,367,366,29,20),
('WK00000486',0,11,2,84,17,367,366,34,42),
('WK00000486',0,11,2,139,17,367,366,30,42),
('WK00000486',0,6,2,109,17,367,366,32,42),
('WK00000486',0,6,2,54,17,367,366,35,42),
('WK00000486',0,6,2,115,17,367,366,33,42),
('WK00000486',0,6,2,116,17,367,366,31,42),
('WK00000486',0,6,2,55,17,367,366,35,42),
('WK00000486',0,6,2,114,17,367,366,33,42),
('WK00000486',0,6,2,94,17,367,366,34,42),
('WK00000486',0,11,2,100,17,367,366,29,42),
('WK00000486',0,11,2,138,17,367,366,30,42),
('WK00000486',0,6,2,59,17,367,366,31,42),
('WK00000187',9,12,3,237,5,367,366,31,40),
('WK00000187',9,12,3,154,5,367,366,29,40),
('WK00000199',5,8,2,46,19,367,366,29,26),
('WK00000199',5,8,2,248,19,367,366,31,26),
('WK00000199',5,8,2,120,19,367,366,30,26),
('WK00000221',12,11,0,130,8,367,366,30,13),
('WK00000221',12,11,0,48,8,367,366,29,13),
('WK00000222',12,11,3,110,12,367,366,32,61),
('WK00000222',12,11,3,228,12,367,366,31,61),
('WK00000229',1,4,0,59,7,367,366,31,58),
('WK00000229',1,4,0,131,7,367,366,30,58),
('WK00000229',1,4,0,48,7,367,366,29,58),
('WK00000231',4,5,3,234,17,367,366,31,8),
('WK00000231',4,5,3,185,17,367,366,31,8),
('WK00000231',4,5,3,184,17,367,366,31,8),
('WK00000231',4,5,3,186,17,367,366,31,8),
('WK00000231',4,5,3,233,17,367,366,31,8),
('WK00000231',4,5,3,154,17,367,366,29,8),
('WK00000237',9,12,2,105,5,367,366,32,32),
('WK00000237',9,12,2,46,5,367,366,29,32),
('WK00000237',9,12,2,228,5,367,366,31,32),
('WK00000237',9,12,2,123,5,367,366,30,32),
('WK00000302',11,13,3,240,17,367,366,31,19),
('WK00000302',11,13,3,209,17,367,366,32,19),
('WK00000302',11,13,3,154,17,367,366,29,19),
('WK00000314',2,1,3,228,17,367,366,31,21),
('WK00000314',2,1,3,21,17,367,366,32,21),
('WK00000314',2,1,3,101,17,367,366,29,21),
('WK00000320',12,11,3,240,17,367,366,31,41),
('WK00000320',12,11,3,169,17,367,366,29,41),
('WK00000320',12,11,3,28,17,367,366,29,41),
('WK00000320',12,11,3,46,17,367,366,29,41),
('WK00000327',3,3,2,59,21,367,366,31,24),
('WK00000327',3,3,2,22,21,367,366,30,24),
('WK00000327',3,3,2,154,21,367,366,29,24),
('WK00000490',12,11,2,154,17,367,366,29,33),
('WK00000348',12,11,2,48,12,367,366,29,2),
('WK00000348',12,11,2,60,12,367,366,31,2),
('WK00000348',12,11,2,209,12,367,366,32,2),
('WK00000492',9,12,2,228,17,367,366,31,62),
('WK00000492',9,12,2,217,17,367,366,30,62),
('WK00000492',9,12,2,103,17,367,366,29,62),
('WK00000492',9,12,2,133,17,367,366,29,62),
('WK00000492',9,12,2,117,17,367,366,29,62),
('WK00000494',5,8,2,248,19,367,366,31,50),
('WK00000494',5,8,2,46,19,367,366,29,50),
('WK00000494',5,8,2,228,19,367,366,31,50),
('WK00000494',5,8,2,123,19,367,366,30,50),
('WK00000363',4,5,3,59,17,367,366,31,11),
('WK00000363',4,5,3,137,17,367,366,31,11),
('WK00000363',4,5,3,154,17,367,366,29,11),
('WK00000506',NULL,NULL,2,228,22,367,366,31,28),
('WK00000506',NULL,NULL,2,140,22,367,366,30,28),
('WK00000506',NULL,NULL,2,154,22,367,366,29,28),
('WK00000378',7,7,0,73,10,367,366,31,47),
('WK00000380',10,9,2,60,6,367,366,31,5),
('WK00000380',10,9,2,103,6,367,366,29,5),
('WK00000380',10,9,2,215,6,367,366,30,5),
('WK00000380',10,9,2,212,6,367,366,32,5),
('WK00000380',10,9,2,213,6,367,366,32,5),
('WK00000380',10,9,2,134,6,367,366,29,5),
('WK00000380',10,9,2,209,6,367,366,33,5),
('WK00000381',10,0,1,60,17,367,366,31,16),
('WK00000381',10,0,1,99,17,367,366,29,16),
('WK00000381',10,0,1,197,17,367,366,30,16),
('WK00000511',3,2,1,243,13,367,366,31,59),
('WK00000511',3,2,1,196,13,367,366,30,59),
('WK00000384',5,10,2,89,4,367,366,29,34),
('WK00000384',5,10,2,87,4,367,366,31,34),
('WK00000384',5,10,2,129,4,367,366,30,34),
('WK00000384',5,10,2,73,4,367,366,31,34),
('WK00000384',5,10,2,46,4,367,366,29,34),
('WK00000388',9,12,3,242,5,367,366,31,52),
('WK00000388',9,12,3,154,5,367,366,29,52),
('WK00000499',0,11,2,248,9,367,366,31,0),
('WK00000499',0,11,2,105,9,367,366,32,0),
('WK00000499',0,11,2,123,9,367,366,30,0),
('WK00000499',0,11,2,46,9,367,366,29,0),
('WK00000496',12,11,3,48,12,367,366,29,64),
('WK00000496',12,11,0,189,12,367,366,32,64),
('WK00000422',6,11,3,218,17,367,366,30,49),
('WK00000433',4,14,2,60,12,367,366,31,22),
('WK00000433',4,14,2,215,12,367,366,30,22),
('WK00000433',4,14,2,101,12,367,366,29,22),
('WK00000433',4,14,2,59,12,367,366,31,22),
('WK00000434',4,14,0,106,11,367,366,32,37),
('WK00000444',3,4,3,240,17,367,366,31,23),
('WK00000444',3,4,3,214,17,367,366,30,23),
('WK00000444',3,4,3,154,17,367,366,29,23),
('WK00000446',0,11,2,60,25,367,366,31,6),
('WK00000446',0,11,2,211,25,367,366,32,6),
('WK00000446',0,11,2,101,25,367,366,29,6),
('WK00000449',4,5,0,232,16,367,366,31,35),
('WK00000449',4,5,0,130,16,367,366,30,35),
('WK00000449',4,5,0,48,16,367,366,29,35),
('WK00000454',12,11,0,130,23,367,366,30,36),
('WK00000454',12,11,0,109,23,367,366,32,36),
('WK00000454',12,11,0,48,23,367,366,29,36),
('WK00000519',11,NULL,1,191,0,367,366,32,51),
('WK00000519',11,NULL,1,196,0,367,366,30,51),
('WK00000519',11,NULL,1,60,0,367,366,31,51),
('WK00000519',11,NULL,1,48,0,367,366,29,51),
('WK00000519',11,NULL,1,33,0,367,366,29,51),
('WK00000470',8,8,0,126,25,367,366,30,30),
('WK00000470',8,8,0,182,25,367,366,31,30),
('WK00000203',3,NULL,2,150,20,367,366,29,43);
